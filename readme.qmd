---
title: "OpenPrescription EDA"
author: "Juan Fonseca"
format: gfm
---

This work is based on data from [OpenPrescribing](https://openprescribing.net/).

## Obtaining boundaries

```{r}
library(sf)
library(tidyverse)
```

## Boundaries of all Sub-ICB Locations

Practices are grouped in sub-ICB. The following code extracts the boundaries for all ICBs in the country

```{r}
CCG_boundaries <- geojsonsf::geojson_sf("https://openprescribing.net/api/1.0/org_location/?org_type=ccg")
```

```{r}
mapview::mapview(CCG_boundaries)
```

## GP surgeries

Approximate locations of all registered GP surgeries can be obtained. For example, for Leeds (ICB code: `15F)`

```{r}
Leeds_Practices <- geojsonsf::geojson_sf("https://openprescribing.net/api/1.0/org_location/?q=15F")
```

```{r}
mapview::mapview(Leeds_Practices)
```

## Getting data of respiratory `tag` for Leeds

There are two relevant metrics which are readily available:

-   Short acting beta agonist inhalers

-   High dose inhaled corticosteroids

The metrics are produced for each month. Producing a moving average is possible but it will requires to build the database with the raw data, also prescriptions have been normalised in the processed dataset.

### Short acting beta agonist inhalers

See: <https://openprescribing.net/measure/saba/definition/>

Taken from the web:

> ***Why it matters:** Why Asthma Still Kills reports that high use of short acting beta agonists (salbutamol and terbutaline) and poor adherence to inhaled corticosteroids in asthma suggests poor control - these patients should be reviewed regularly to ensure good control.*
>
> *The NHS England National Medicines Optimisation Opportunities for 2023/24 identify improving patient outcomes from the use of inhalers as an area for improvement.*
>
> ***Description:** Prescribing of short acting beta agonist (SABA) inhalers - salbutamol and terbutaline - compared with prescribing of inhaled corticosteroid inhalers and SABA inhalers*

```{r}
saba <- read_csv("https://openprescribing.net/api/1.0/measure_by_practice/?format=csv&org=15F&parent_org_type=ccg&measure=saba")
```

### High dose inhaled corticosteroids

See: <https://openprescribing.net/measure/icsdose/definition/>

Taken from the web:

> ***Why it matters:** Latest BTS/SIGN guidance on the treatment of asthma recommends that patients should be maintained at the lowest possible dose of inhaled corticosteroid. Reduction in inhaled corticosteroid dose should be slow as patients deteriorate at different rates. Reductions should be considered every three months, decreasing the dose by approximately 25â€“50% each time. This measure uses table 12 of the BTS/SIGN guidance to define which inhalers are considered high-dose.*
>
> *The latest guidance for treatment of COPD now recommends use of another treatment in preference to inhaled corticosteroids. There is some evidence that inhaled corticosteroids increases the risk of pneumonia. This risk appears to increase with dose.*
>
> ***Description:** Prescribing of high dose inhaled corticosteroids compared with prescribing of all inhaled corticosteroids*

```{r}
icsdose <- read_csv("https://openprescribing.net/api/1.0/measure_by_practice/?format=csv&org=15F&parent_org_type=ccg&measure=icsdose")
```

### Exploring the data

It is possible to extract the trends of both metrics. Below a graphical extract of one of the metrics for Leeds.

```{r}
head(saba)
saba |> 
  ggplot(aes(x = date,
             y = calc_value,
             groups = org_id,
             col = mycol,
             alpha = myalpha))+
  geom_line(alpha = 0.4, col = "gray")+
  geom_line(data = saba[grep(pattern = "STUDENT",saba$org_name),],
            col = "blue",
            alpha = 0.8)+
  theme_minimal()+
  labs(title = "Ratio of Prescribed SABA over inhaled corticosteroid inhalers + SABA",
       y = "value",
       subtitle = "Blue: LEEDS STUDENT MEDICAL PRACTICE"
  )
```
